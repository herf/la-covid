<html>
<head>
<title>LAUSD case rates</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=0.5, shrink-to-fit=no">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<!-- for CSV mainly since gcharts -->
<script src="https://d3js.org/d3.v5.min.js"></script>

<style>
body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif; background-color:#fbfbfb;}
.footer {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 60px; /* Set the fixed height of the footer here */
  line-height: 60px; /* Vertically center the text there */
  background-color: #f5f5f5;
}
td,th {
	padding-right:1em;
}

.warning {
	background-color: #f8c629;
}
</style>
</head>
<body>

<script>

    var feed = "./LAUSD-rates.csv";
    var ratedata, actdata;
    var havechart = 0;

    var userfilter;

    d3.csv(feed).then(function(d) {
        ratedata = d;
        if (havechart) drawChart();
    });

    var feed2 = "./LAUSD-active.csv";

    d3.csv(feed2).then(function(d) {
        actdata = d;
        console.log(actdata);
        if (havechart) drawActiveChart();
    });
</script>

<script>
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(haveChart);

  function haveChart() {
    havechart = 1;
    if (ratedata) drawChart();
    if (actdata) drawActiveChart();
  }

  function drawChart() {

    // csv format:
    var datatable = [];
    datatable.push(["Date", "Average Case Rate"]);

    var lastdate;
    var ratesum = 0;
    var ratect = 0;

    // go "out of bounds" by one to summarize the last:
    for (var i = 0; i <= ratedata.length; i++) {

        if (i == ratedata.length || ratedata[i].date != lastdate) {
            var row = [];
            if (ratect) {
                row.push(new Date(lastdate));
                row.push(ratesum / ratect);
                datatable.push(row);
            }

            // don't go past array
            if (i == ratedata.length) break;

            ratesum = 0;
            ratect = 0;
            lastdate = ratedata[i].date;
        }
        // ignore "region" as we are averaging:
        ratesum += parseFloat(ratedata[i].caserate);
        ratect ++;
    }

    var options = {
      //title: 'Average Case Rate (daily increase in cases/100,000)',
      legend: { position: 'bottom' },
      //chartArea: {width: '80%', left: '0%', height: '80%'},
      hAxis: {
        format: 'MMM d'
      },
      vAxis: {
        baseline: 0
      }
    };

    var chart = new google.visualization.ColumnChart(document.getElementById('rate_chart'));
    var dt = google.visualization.arrayToDataTable(datatable);
    chart.draw(dt, options);
  }

  function drawOutbreakTable(actdata) {
        var td = [];
        td.push("<table class='p-3 table table-striped table-hover'><thead><tr><th>Date</th><th>School name</th><th>Cases</th></tr></thead><tbody>");
        for (var i = actdata.length - 1; i >= 0; i--) {
            var ai = actdata[i];
            if (ai.inschool > 0) {
                td.push("<tr><td>" + ai.date + "</td><td>" + ai.school + "</td><td>" + ai.inschool + "</td></tr>");
            }
        }

        td.push("</tbody></table>");

        document.getElementById('outbreak').innerHTML = td.join('');
  }

  function setfilter(f) {
    userfilter = f.toLowerCase();
    console.log(userfilter);
    drawActiveChart();
  }

  function clearfilter() {
    document.getElementById('schoolfilt').value = v;
    setfilter(nil);
  }

  function drawActiveChart() {

    // csv format:
    var datatable = [];
    //datatable.push(["Date", "Community cases", "In-school cases"]);
    datatable.push(["Date", "Community + In-school cases"]);
    if (userfilter && 0) {
        datatable[0].push("{role: 'style'}");
        datatable[0].push("{role: 'annotation'}");
    }

    console.log(datatable[0]);

    var lastdate;
    var ratesum = 0;

    var schoollist = {};

    // go "out of bounds" by one to summarize the last:
    for (var i = 0; i <= actdata.length; i++) {

        if (i == actdata.length || actdata[i].date != lastdate) {
            var row = [];
            if (ratesum) {
                row.push(new Date(lastdate));
                row.push(ratesum);
                if (userfilter && 0) {
                    row.push("gray");
                    row.push(ratesum.toString());
                }
                console.log(row);
                datatable.push(row);
            }

            // don't go past array
            if (i == actdata.length) break;

            ratesum = 0;
            lastdate = actdata[i].date;
        }

        var passfilter = false;
        if (!userfilter) {
            passfilter = true;
            schoollist[actdata[i].school] = 1;  // kind of
        }
        if (userfilter && actdata[i].school.toLowerCase().indexOf(userfilter) != -1) {
            passfilter = true;
            schoollist[actdata[i].school] = 1;
        }

        if (passfilter) {
            ratesum += parseFloat(actdata[i].community) + parseFloat(actdata[i].inschool);
        }
    }

    var maxschool = 25;
    var slist = [];
    for (k in schoollist) slist.push(k);

    var actlabel = "Active Cases ";
    if (slist.length > 500) actlabel += "(total for all schools)";
    else if (slist.length == 1) actlabel += "(total for " + slist[0] + ")";
    else actlabel = "Active Cases (total for " + slist.length + " schools called " + userfilter + ")";
    document.getElementById("acttitle").textContent = actlabel;//"Active Cases (total for " + slist.length + " schools)";

    if (slist.length > maxschool) {
        var d25 = slist.length - maxschool;
        var stext = slist.slice(0, maxschool);

        document.getElementById('filtermatch').textContent = stext + " and " + d25 + " more.";
    } else {
        document.getElementById('filtermatch').textContent = slist.join(", ");
    }

    var options = {
      //title: 'Active cases (sum over all schools)',
      legend: { position: 'bottom' },
      //chartArea: {width: '80%', left: '0%', height: '80%'},
      hAxis: {
        format: 'MMM d'
      },
      vAxis: {
        baseline: 0
      }
    };

    var chart = new google.visualization.ColumnChart(document.getElementById('active_chart'));
    var dt = google.visualization.arrayToDataTable(datatable);
    chart.draw(dt, options);

    drawOutbreakTable(actdata);
  }

window.onresize = function() {
    drawChart();
    drawActiveChart();
}

</script>


<main class="container-fluid mt-5">
	<div class="row">

		<div class="col-xl-6 col-lg-8 col-md-12 off-xl-4 offset-lg-2">
            <h1>LAUSD COVID-19 test results <small>(2021-2022)</small></h1>
            <h5 class='text-muted'>As reported by LAUSD COVID Report Card</h5>

            <div class='row'>
                <div class='col-sm-12 mt-4'>
                <label for="schoolfilt">Filter by school name:</label>
                </div>
                <div class='col-sm-12 col-md-6'>
                    <input class="form-control" id="schoolfilt" type="text" placeholder="Type a school name..." onchange="setfilter(this.value)" onkeyup="setfilter(this.value)">
                </div>
                <div class='col-sm-12 col-md-6'>
                    <button class="btn btn-primary" onclick="clearfilter();return 0;">Clear Filter</button>
                </div>
            </div>
            <small>
            <div class='mt-2 text-muted' id='filtermatch'></div>
            </small>

            <div class="card mt-4">
              <div class="card-body">
                <h5 class="card-title" id='acttitle'>Active Cases (total for all schools)</h5>
                <div id="active_chart" style="height: 400px"></div>
                <p class="card-text text-muted mt-3">Positive cases among staff and students – the number of staff and students that have recently tested positive for COVID-19 and are considered “active” cases that are in isolation.</p>
              </div>
            </div>

            <div class="card mt-4">
                  <div class="card-body">
                    <h5 class='card-title'>Cases from school-based transmission</h5>
                    <div id='outbreak' style='height: 240px; overflow: auto'></div>
                    <p class="text-muted mt-1">Positive test cases were determined to be epidemiologically (epi)-linked through contact tracing. Two cases may be epi-linked when they were both present in the same setting during the time period while either or both were infectious.
                    </p>
                </div>
            </div>


            <div class="card mt-4">
              <div class="card-body">
                <h5 class="card-title">Average Case Rate (daily increase in cases/100,000</h5>
                <div id="rate_chart" style='height: 400px' ></div>
                <p class="card-text text-muted mt-3">Staff and Student Case Rate – 7-day rolling average of daily cases per 100,000 students and school-based staff across the entire district.</p>
              </div>
            </div>
        </div>
    </div>
</main>
</body>
</html>